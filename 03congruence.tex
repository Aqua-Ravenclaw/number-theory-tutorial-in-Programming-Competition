\chapter{同余}

\begin{introduction}
\item 同余方程
\item 快速乘、快速幂
\item 逆元、线性求区间逆元
\item 中国剩余定理
\item 欧拉降幂
\item 卡米歇尔数
\item Miller\_Rabin
\item Pollard\_Rho
\item 离散对数
\item 原根
\end{introduction}


\section{同余式与同余方程}
\subsection{同余式}
整除性是很好的性质，这在最大公因数、模线性方程和素数分解中均得到了体现。而同余式提供了一种
描述整除性质的简便方式。

\begin{definition}{同余}{label}
	如果$m|(a-b)$，我们就说a与b模m同余并记之为$a\equiv b(mod\ m)$。
	
	特别地，$a\equiv a\%m(mod\ m)$ 。
\end{definition}

数m叫做同余式的模。 具有相同模的同余式在许多方面表现得很像通常的等式。例如：

若$a_1\equiv b_1(mod\ m) \ ,\quad a_2\equiv b_2(mod\ m)$     则$a_1\pm a_2\equiv b_1\pm b_2(mod \ m)$ ，$a_1a_2\equiv b_1b_2(mod \ m)$ 

{\heiti 但 $ac\equiv bc(mod \ m)$ 时，未必有$a\equiv b(mod \ m)$，只有$gcd(c,m)=1$，才可以消去c。}


\subsection{同余方程}
如果同余式含有未知数，我们考虑如何求解。

首先考虑“穷举法” ，要解模m同余式，可让每个变量试取0,1,2...,m-1。例如，解同余式$x^2+2x-1\equiv 0(mod\ 7)$，
就去试$x=0\quad, x=1\quad,...\quad,x=6$，这样可以求出两个解$x\equiv 2(mod\ 7)$和$x\equiv 3(mod\ 7)$ 当然还有其他解，但新的解与2或3是同余的，如9和10。当我们说“求同余式的所有解时”，是指求所有不同余的解，即相互不同余的所有解。

许多同余式是没有解的，如$x^2\equiv 3(mod\ 10)$。

\vbox{}

下面考虑如何求解同余式$ax\equiv c(mod\ m)$。 
\begin{example}
解同余式$18x\equiv8(mod\ 22)$
\end{example}

等价于求$22\ |\ (18x-8)$，即求$18x-22y=8$。       

解这类方程的问题在第一章中研究过。

对于$ax\equiv c(mod\ m)$ ，其有解{\heiti 当且仅当}线性方程$ax-my=c$ 有解。


由前可知，线性方程$ax-my=c$ 有解的充分必要条件是$gcd(a,m)\ |\ c$。

且方程$au+mv=g$ 一定有解 ，设一个解为$(u_0,v_0)$，则有
$$
a\frac{cu_0}{g}+m\frac{cv_0}{g}=c
$$
这说明$x_0= \frac{cu_0}{g}$是同余式$ax\equiv c(mod\ m)$ 的一个解，通解为$x=x_0+k\cdot \frac{m}{g}$。

{\heiti 由于相差m的倍数的任何两个解认为是相同的}，所有恰好有$g$个不同的解，这些解通过取$k=0,1,2...,g-1$而得到。将上述过程概述为定理：


\begin{theorem}{线性同余式定理$ax\equiv c(mod\ m)$}{label}
设a,c与m是整数，m>=1,且设$g=gcd(a,m)$。 

(a)  如果$g\nmid c$，则同余式$ax\equiv c(mod\ m)$ 没有解

(b)  如果$g\ |\ c$ ，则同余式$ax\equiv c(mod\ m)$ 恰好有g个不同的解。要求这些解，首先求线性方程$au+mv=g$ 的一个解$(u_0,v_0)$ 
{\heiti (欧几里得回带法，在计算机上递归求得，称为扩展欧几里得算法)} 。则$x_0=(\frac{cu_0}{g}\% \frac{m}{g} + \frac{m}{g}) \% \frac{m}{g}$是$ax\equiv c(mod\ m)$ 的解，不同余解的完全集由
$$
x\equiv x_0+k\cdot \frac{m}{g} \  (mod\ m),\quad k=0,1,2,...,g-1
$$
给出。
\end{theorem}


例如，同余式$943x\equiv 381(mod\ 2576)$ 无解，这是因为$gcd(943,2576) \nmid 381$。

另一方面，同余式$893x\equiv 266(mod\ 2432) $
有19个解，因为$gcd(893,2432)=19,\  19|266$     这个19即为不同余解的个数。

下面解方程$893u-2432v=19$ ，使用欧几里得回带法可以求得解$(u,v)=(79,29)$ ，乘以266/19=14得方程$893x-2432y=266$的解$(x,y)=(1106,406)$ ，
即1106是同余式方程的一个解，这样的互不同余的解共有19个。1106加上2432/19=128的倍数(\%2432)就可得到完全解集。


\begin{remark}
	线性同余式定理最重要的情形是$gcd(a,m)=1$ ，在这种情形下，同余式恰好有一个解。
\end{remark}

\lstinputlisting[language=C++, style=codestyle2]{code03/modequation.cpp}

\vbox{}

对于非线性的同余式，其解“不是很确定”。

我们熟悉的是对于{\heiti 一个d次实系数多项式的实根不超过d个} ，这个结论对于同余式并不成立。

例如$x^2+x\equiv 0(mod\ 6)$ 有4个模6不同的根：0,2,3,5。

但是，{\heiti 当p为素数时，这个结论依然成立:}

\begin{theorem}{模p多项式根定理}{label}
设p为素数，$f(x)=a_0x^d+a_1x^{d-1}+...+a_d$ 是次数为d>=1的整系数多项式，且p不整除$a_0$ ，则同余式$f(x)\equiv 0(mod\ p)$ 最多有d个模p不同余的解。
\end{theorem}

\section{快速乘与快速幂}
快速乘和快速幂作为工具经常在程序设计竞赛中遇见。
\subsection{快速乘}
在$C++$中，变量最多只能表示到$2^{64}-1$这么大，所以如果我们要计算$a*b\%c$，而$a,b$都是接近表示上限的数，这个时候就需要快速乘。
即将$b$按二进制位分解分别加上，时间复杂度为$O(log(b))$。
\lstinputlisting[language=C++, style=codestyle2]{code03/fastmul.cpp}

\subsection{$O(1)$快速乘}



\subsection{快速幂}
现在我们要计算$a^b\%c$，如果乘$b$次，时间复杂度太高，考虑将$b$按照二进制分解，每一位分别计算并乘在一起即可。
时间复杂度为$O(log(b))$。相比于快速乘，只是加法变了乘法。
\lstinputlisting[language=C++, style=codestyle2]{code03/fastexp.cpp}


\section{费马小定理与逆元}
前面我们讨论了关于同余式、同余方程的一些性质，小结一下，互质这个条件很重要。

\begin{itemize}
	\item 对于$ac\equiv bc(mod \ m)$，如果$gcd(c,m)=1$，则可以消去c，得到$a\equiv b(mod \ m)$ 。
	\item 对于同余方程 $ax\equiv c(mod\ m)$，若$gcd(a,m)=1$ ，同余式恰好有一个解。
\end{itemize}

{\heiti 对于式子$ax\equiv c(mod\ m)$，令$c=1$，得$ax\equiv 1(mod\ m)$，若$gcd(a,m)=1$，则方程有唯一解$x_0$，
我们称$x_0$为$a$在模$m$意义下的逆元，常记作$a^{-1}$。}

逆元可以用来说明一些事情，比如如果$ac\equiv bc(mod\ m)$，若$gcd(c,m)=1$，
则存在$c^{-1}$使得$cc^{-1}\equiv 1 (mod\ m)$。所以可以对$ac\equiv bc(mod\ m)$两边同时乘以$c^{-1}$，得到$a\equiv b(mod\ m)$。

如何求解逆元呢？拓展欧几里得即可，因为就是一个同余方程：
\lstinputlisting[language=C++, style=codestyle2]{code03/inverse.cpp}

\vbox{}

若模数是素数，我们还可以用费马小定理求解。

\begin{theorem}{费马小定理}{femat}
	设p是素数，a是任意整数且$p\nmid a$ ，则 $a^{p-1}\equiv 1(mod\ p)$。 
\end{theorem}

在证明费马小定理之前，先来看一个引理。

\begin{lemma}{为证明费马小定理做准备}{forfemat}
	设$p$是素数，a是任何整数且 $p\nmid a$ 则数
	$$
	a,2a,3a,...,(p-1)a\qquad (modp)
	$$
	与数
	$$
	1,2,3,...,(p-1)\qquad (modp)
	$$
	相同，尽管它们的次序不同。
\end{lemma}

\begin{proof}
	数列$a,2a,3a,...,(p-1)a$，包含$p-1$个数，显然没有一个数被$p$整除 ，假设从中取出两个数ja和ka是关于p同余的，即$p|(j-k)a$，
	又p是素数且p不整除a，所以p整除$(j-k)$。但是$|j-k|<p-1 $，所以$j-k=0$，即$j=k$。
	
	这表明，这p-1个数模p不同，由于任何数mod p仅有$p-1$个不同的非零值，证毕。
\end{proof}

\begin{proof}
	费马小定理的证明。
	
	利用该引理\ref{lem:forfemat}，即可完成对费马小定理\ref{thm:femat}的证明，将上面引理列到的两组数相乘，可得到
	$$
	a^{p-1} \cdot (p-1)!\equiv (p-1)!   \qquad (modp)
	$$
	由于$(p-1)!$与p互质（显然除了1没有其它公共因子了），可以消去它(本节开头有提到这个性质)，则$a^{p-1}\equiv 1(mod\ p)$。
\end{proof}

\vbox{}

有了费马小定理，若模数$m$是质数，则数$a$关于$m$的逆元就是$a^{m-2}$，因为$a* a^{m-2} \equiv 1 \ (mod p)$。
使用快速幂直接计算即可。

\vbox{}

{\heiti 使用费马小定理还可以进行素数测试}，后面小节会提到。

\section{中国剩余定理}

\begin{theorem}{中国剩余定理}{CRT}
	设m与n是整数，$gcd(m,n)=1$，b与c是任意整数,则同余式组
	$x\equiv b(mod\ m)$与$x\equiv c(mod\ n)$恰有一个解$0\leqslant x<mn$。
\end{theorem}

\begin{proof}
	对于第一个同余式$x\equiv b(mod\ m)$，其解由形如$x = my +b$的所有数组成。将其带入第二个方程可得
	$my\equiv c-b (mod\ n)$，已知$gcd(m,n)=1$，由线性同余式定理知其恰有一个解$y_1,\ 0\le y_1<n$，则$x_1=my_1+b$
	给出了原来同余式组的解，这是在$[0,mn)$之间的唯一解。
\end{proof}

\vbox{}

上面只考虑了两个同余式，如果有多个呢？

\begin{custom}{问题}
	求出方程组$x\equiv a_i(mod \ m_i) (0 \leqslant i <n) $ 的解$x$，其中$m_0,m_1,m_2,m_3,...,m_{n-1}$ 两两互质。
\end{custom}

\begin{solution}
	令$M_i=\prod_{j\neq i}m_j$     则有$(M_i,m_i)=1$   
	
	故存在$p_i,q_i$ ，使得$M_i*p_i+m_i*q_i=1$ 
	
	令  $e_i=M_ip_i$，\quad    $p_i$即为$M_i$ 模$m_i$下的逆元。   
	
	则有
$$
e_i\equiv\left\{\begin{matrix}
0(mod\ m_j)\ ,\ j\neq i\\ 
1(mod\ m_j)\ ,\ j=i
\end{matrix}\right.	
$$	
	故$e_0a_0+e_1a_1+e_2a_2+...+e_{n-1}a_{n-1}$是方程的一个解。
	
	由中国剩余定理知，$[0\sim\prod_{i=0}^{n-1}m_i\}$ 中必有一解，将上式模$\prod_{i=0}^{n-1}m_i$即可。 
\end{solution}

时间复杂度  $O(nlogm)$，其中$n$表示有$n$个方程。

\lstinputlisting[language=C++, style=codestyle2]{code03/crt.cpp}

\begin{custom}{问题}
	如果这些方程的{\heiti 模数不互质}呢？（上面互质的方法只是一种巧妙的构造）
\end{custom}

一样可以求解，每一次我们将两个方程合并为一个方程，具体来说，假设目前的前两个方程为$x\equiv a_1 \ (mod\ m_1),\quad  x\equiv a_2 \ (mod\ m_2)$。
将第一个带入第二个可得到$km_1\equiv a_2-a_1 \ (mod\ m_2)$，解这个同余方程，求出$k$的最小正整数解$k_0$，那么$k = \frac{m_2}{gcd}y+ k_0$，带入
$x=km_1+a_1$中可以得到$x=\frac{m_1m_2}{gcd}y+m_1k_0+a_1$，也即将前两个方程合并为了一个：$x\equiv m_1k_0+a_1\ (mod\ \frac{m_1m_2}{gcd})$，
这样迭代下去，最后的那个方程即为所求。

时间复杂度为$nlogm$，其中$n$是方程个数。{\heiti 代码中的$x_0$即为上面的$k_0$。}

\lstinputlisting[language=C++, style=codestyle2]{code03/excrt.cpp}

\section{欧拉公式与欧拉降幂}

\subsection{欧拉公式}

费马小定理很漂亮$a^{p-1}\equiv 1(mod\ p)$，但限制$p$是素数且$p\nmid a$。如果$p$是合数，即使$a,p$互质，结论也不正确了。
那是否有$a^{???}\equiv 1(mod\ m)$成立的指数呢？带规律的那种。
首先，如果a的某个幂模m余1，则a和m必互质(可由线性方程定理证明)。

这再次提醒我们观察与m互素的数的集合：
$$
{a:1\leqslant a\leqslant m,\quad gcd(a,m)=1}
$$
{\heiti 在1$\sim$m之间与m互质的整数个数}是个重要的量，我们赋予这个量一个名称：


\begin{definition}{欧拉函数$\varphi$}{label}
$$
\varphi(m)=\{a:1\leqslant a\leqslant m,\quad gcd(a,m)=1\}
$$
\end{definition}

注意p是素数时，每个整数$1\leqslant a<p$ 都与p互素，所以对于素数p有公式
$$
\varphi(p)=p-1
$$
我们设法模仿费马小定理的证明。例如，假设要求7的幂次模10余1，不取所有1$\sim$9，而是恰好取与10互素的数，它们是
$$
1,3,7,9
$$
如果用7去乘每个数可得
$$
7\cdot 1\equiv 7(mod\ 10)\quad 7\cdot 3\equiv 1(mod\ 10)\quad
7\cdot 7\equiv 9(mod\ 10)\quad 7\cdot9\equiv 3(mod\ 10)
$$
{\heiti 得到的4个数是之前的4个数的重排！}如果将它们乘起来就得到相同的乘积
\begin{align*}
(7\cdot 1)(7\cdot 3)(7\cdot7)(7\cdot9)\equiv 1\cdot3\cdot7\cdot9  \qquad  (mod\ 10)  \\
7^4(1\cdot3\cdot7\cdot9)\equiv 1\cdot3\cdot7\cdot9 \qquad (mod\ 10)
\end{align*}

由于$1\cdot3\cdot7\cdot9$与$10$是互质的，因此可以消去，所以得到$7^4\equiv 1(mod\ 10)$，这个形式和费马小定理很像了！

考虑这里的指数4和费马小定理中的$p-1$的共同点， 都是1$\sim$m中与m互质的数的个数，即欧拉函数$\varphi(m)$。


\begin{theorem}{欧拉公式}{eulerf}
如果$gcd(a,m)=1$ ，则
$$
a^{\varphi(m)}\equiv 1 (mod\ m)
$$
\end{theorem}

\begin{lemma}{为证明欧拉公式做准备}{foreulerf}
如果$gcd(a,m)=1$，则数列
$$
b_1a,\ b_2a,\ b_3a,\ ...\ ,b_{\varphi(m)}a  \qquad  (mod\ m)
$$
与数列
$$
b_1,\ b_2,\ b_3,\ ...\ ,b_{\varphi(m)} \qquad (mod\ m)
$$
相同，尽管它们可能次序不同，$b_i$表示小于$m$且与$m$互质的数。
\end{lemma}

\begin{proof}
引理的证明。
\begin{itemize}
	\item 注意到$b_i$和a均与m是互质的，则$b_ia$也与m互质。{\heiti 又因为所有与m互质的数\%m后依然与m互质} 
	(如果x-km与m不互质，则x与m也不互质了)，所以数列$b_1a,b_2a,b_3a,...,b_{\varphi(m)}a  \quad  (mod\ m)$ 同
	余于数列$b_1,b_2,b_3,...,b_{\varphi(m)} \quad (mod\ m)$ 中的某一个数(因为就这$\varphi(m)$个和$m$互质)。又
	每个数列有$\varphi(m)$个数 ，因此，如果能进一步证明第一个数列中的数对于模m互不相同，就可得出两个数列(重排后)
	相同。  
	\item 从第一个数列中任选两个数，假设它们是同余的，那么意味着$m\ |\ a(b_i-b_j)$，由于a,m是互质的，因而
	有$m|b_i-b_j$，又 $b_i ,b_j$在1与m之间，这说明$b_i=b_j$，即第一个数列中的数模m是不同的。引理证毕。
\end{itemize}
\end{proof}


\begin{proof}
欧拉公式的证明。

利用该引理\ref{lem:foreulerf}，即可完成对\ref{thm:eulerf}欧拉公式的证明，
由引理知第一个数列中数的乘积等于第二个数列中数的乘积：
$$
(b_1a)\cdot (b_2a)\cdot (b_3a)\cdot \ ...\ \cdot (b_{\varphi(m)}a) \equiv b_1\cdot b_2\cdot b_3 \cdot \cdot \cdot b_{\varphi(m)} \qquad  (mod\ m)
$$
左边提出$\varphi(m)$个a得到  $a^{\varphi(m)}B\equiv B (mod\ m)$，其中$B= b_1 b_2 b_3 \cdot \cdot \cdot b_{\varphi(m)} $。

由于每个$b$与m都是互质的，因此$B$与m也是互质的，因此B可以消去，于是得到
$$
a^{\varphi(m)}\equiv 1 (mod\ m)
$$
证毕。
\end{proof}

关于欧拉函数$\phi$，后面还会遇到。下一节让我们先看一下欧拉公式的一个应用。

\subsection{欧拉降幂}
如何计算$5^{100000000000000}mod\ 12830603$? (实际上会有很多零，比如$10^5$个，这里为了说明问题简写)

如果12830603是素数，则直接使用费马小定理，可以将指数除以p-1，将余数作为幂计算即可。

但12830603=3571*3593，不是素数。

但但，$gcd(5,12830603)=1$，因此由欧拉公式知$5^{\varphi(12830603)}\equiv 1 (mod \ 12830603)$。
计算得到$\varphi(12830603)=12823440$，因此只要把100..000除以12823440的余数作为指数即可。{\heiti 注意这里要求5和12830603互质}。

{\heiti 如果底数和模数不互质呢?有广义欧拉降幂公式}，总结如下：

\begin{theorem}{广义欧拉降幂公式}{label}
	\begin{align*}
	a^b\equiv  \left\{\begin{matrix}
	a^{b\% \phi(p)}&  \quad gcd(a,p)=1 \\
	a^b   \quad  & gcd(a,p)\neq 1,b\le \phi(p) \\
	a^{b\% \phi(p)+\phi(p)} &\quad   gcd(a,p)\neq 1,b>\phi(p)
	\end{matrix}\right. \quad {mod \ p}
	\end{align*}
\end{theorem}


\begin{proof}
	第一行和第二行的式子之前已经说明，下面证明$b>\phi(p)$的情况。
	
	设$b = A*\phi(p) + C$，其中$A\ge1,\ 0\le C<\phi(p)$。
	
	那么我们要证明的就是$a^{ A*\phi(p) + C} \equiv  a^{\phi(p)+C}(\ mod\ p)$。
	
	如果我们能证明$a^{A*\phi(p)} \equiv a^{\phi(p)}( mod\ p)$，则上式也就成立。
	
	即证$a^{2*\phi(p)} \equiv a^{\phi(p)}( mod\ p)$，移项即证
	
	$$p\ |\  a^{\phi(p)}(a^{\phi(p)}-1)$$
	
	(这里p不一定是素数)
	
	假设
	$$
	(\frac{p}{(p\ ,\ a^{\phi(p)})}\ ,\ a)= 1
	$$
	
	那么根据欧拉定理，
	$$
	a^{\phi(p)} = a^{k*\phi(\frac{p}{ {(p,a^{\phi(p)})}})}\equiv {[a^{\phi(\frac{p}{ {(p,a^{\phi(p)})}})}]}^k \equiv 1 \ ,\quad mod\ (\frac{p}{(p,a^{\phi(p)})})
	$$
	其中$k\ge 1$，移项可得$\frac{p}{(p,a^{\phi(p)})}\ |\ (a^{\phi(p) }- 1)$。
	两边同时乘${(p,a^{\phi(p)})}$可得$p\ |\  {(p,a^{\phi(p)})}*(a^{\phi(p)}-1)$，于是也就证明了$p\ |\  a^{\phi(p)}(a^{\phi(p)}-1)$。证毕。
	
	但上面的假设还没有证明，实际上这个假设是一定成立的，下面证明。
	
	对$a$和$p$进行质因数分解，
	$$
		a = p^{a_1}_1*p^{a_2}_2*....*p^{a_{t_1}}_{t_1} * q^{b_1}_1* q^{b_2}_2*...* q^{b_{t_2}}_{t_2}
	$$
	
	$$
		p = p^{c_1}_1*p^{c_2}_2*....*p^{c_{t_1}}_{t_1} *  r^{d_1}_1* r^{d_2}_2*...* r^{d_{t_3}}_{t_3}
	$$
	则$(a,p) = p^{min(a_1,c_1)}_1*p^{min(a_2,c_2)}_2*....*p^{{min(a_{t_1},c_{t_1})}}_{t_1}$，
	
	$(a^{\phi(p)},p) =  p^{min(a_1*\phi(p),c_1)}_1*p^{min(a_2*\phi(p),c_2)}_2*....*p^{{min(a_{t_1}*\phi(p),c_{t_1})}}_{t_1}$。
	
	我们分析一下$a_i*\phi(p)$，$a_i*\phi(p)\ge a_i*p_i^{c_i-1}*(p_i-1) \ge p_i^{c_i-1}*(p_i-1) \ge p_i^{c_i-1}\ge c_i$。(其中$p_i$是$p$的因子)。
	
	于是有$(a^{\phi(p)},p) =  p^{min(a_1*\phi(p),c_1)}_1*p^{min(a_2*\phi(p),c_2)}_2*....*p^{{min(a_{t_1}*\phi(p),c_{t_1})}}_{t_1} = p^{c_1}_1*p^{c_2}_2*....*p^{c_{t_1}}_{t_1}$。
	
	于是
	$$
		(\frac{p}{(p\ ,\ a^{\phi(p)})}\ ,\ a)= 1
	$$
	证毕。
\end{proof}

实际上，广义欧拉降幂公式说明的是$a^b\%c$循环节的问题，

这里\href{https://math.stackexchange.com/questions/653682}{https://math.stackexchange.com/questions/653682}
有相关的讨论，$\phi(c)$不一定是最小的循环节长度。

\begin{example}
2019南京网络赛B.superlog，题目经简化后即求$a^{a^{...}} \% m$的值，其中$...$共有$b$个$a$，数据范围是$a,b,m\ \le 10^6$。
\end{example}

由于$m$的范围已知，发现只有很少个形如$a^{a^{...}}$的式子的真值会比$m$小，提前预处理一下即可，这也是比较常见的做法，因为指数套指数增长的非常快。

代码如下，时间复杂度为$O(T*log(m)*\sqrt{m})$。

\lstinputlisting[language=C++, style=codestyle2]{code03/superlog.cpp}


\subsection{威尔逊定理}


\section{素性测试}


\section{Pollard\_Rho质因数分解}


\section{离散对数}


\section{原根}




\begin{problemset}
	\item \href{http://poj.org/problem?id=2891}{Strange Way to Express Integers \quad POJ2891 \quad 同余方程组，模数不一定互质}  
	\item \href{https://cn.vjudge.net/problem/Gym-101550E#}{Exponial \quad 欧拉降幂}
	\item \href{}{ \quad 威尔逊定理的应用}
\end{problemset}

